<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Title</title>
    <script src="compute-boids-utils.js">


    </script>
</head>
<body>
<canvas id='test' width="600" height="600"></canvas>
<script>
	async function test(){
		await Utils.ready;
		console.log(Utils)

		// gpu엔 뭐가 있나...
		// requestAdapter를 가지는 GPU객체를 반환해 주는군...
		let gpu =  navigator.gpu;
		let swapChain;
		console.log(gpu);


		const positionAttributeNum  = 0;
		const colorAttributeNum     = 1;
		const transformBindingNum   = 0;
		const bindGroupIndex        = 0;
		const shader = `
        struct FragmentData {
            float4 position : SV_Position;
            float4 color : attribute(${colorAttributeNum});
        }
        vertex FragmentData vertex_main(
            float4 position : attribute(${positionAttributeNum}),
            float4 color : attribute(${colorAttributeNum}),
            constant float4x4[] modelViewProjectionMatrix : register(b${transformBindingNum}))
        {
            FragmentData out;
            out.position = mul(modelViewProjectionMatrix[0], position);
            out.color = color;

            return out;
        }

        fragment float4 fragment_main(float4 color : attribute(${colorAttributeNum})) : SV_Target 0
        {
            return color;
        }
`;


		// gpu객체에서 어댑터를 얻어와야한다.
		gpu.requestAdapter().then(adapter => {

			console.log('adapter', adapter)
			// ??? 어댑터는 시스템상에 구현된 webGPU의 구현을 나타난다고 한다. (정확히 먼소린지는 알아봐야겠군..)
			// 어댑터를 얻어와서 디바이스를 또 요청해야함
			adapter.requestDevice().then(device => {
				console.log('device', device)
				// GPUAdapter를 반환하는데 어떤 어댑터를 가지고 왔는지와
				// lost 핸들링 프라미스를 가진 GPUDevice  인스턴스가 반환됨
				// 실질적인 GPU 명령 집합체군..

				// 디바이스를 얻었으면 캔버스와 연결을 해야하나봄봄
				const canvas = document.querySelector('canvas');
				const context = canvas.getContext('gpupresent');
				const swapChainDescriptor = {
					device: device,
					format: "bgra8unorm"
				};
				// 캔버스 컨텍스트를 실제로 구성하나봄
				swapChain = context.configureSwapChain(swapChainDescriptor);
				console.log(swapChain)

                /**
                     여기서 부터 전쟁이구나~~
                     컴파일 저녀석부터 종류별 상황별로 어찌하나 파야함
                 **/
				// const shaderModuleDescriptor = {
				// 	code: Utils.compile("c", shader),
				// 	isWHLSL : false
				// };
				// const shaderModule = device.createShaderModule(shaderModuleDescriptor);
				// console.log('shaderModule',shaderModule)
			});
		}).catch(error => {
			console.log(error)
			alert('WebGPU is unsupported, or no adapters or devices are available.')

		});
    }
    test()
</script>
</body>
</html>